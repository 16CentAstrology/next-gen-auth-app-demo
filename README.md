# Next-Gen-Auth

A basic Rails/React demo app created to showcase [Shopify's Next-Gen Auth][1].

## Getting started

> **Important:** The session token feature is currently restricted to
  participants of a private beta. The feature is scheduled for general release
  in Summer 2020.

If you are looking to install this app on your own testing environment, and
already have a `Shopify API Key` and `Shopify API Secret` from your partners
dashboard, you can pull this repository and run the following:

```console
$ bundle install
$ yarn install
$ rails db:migrate
```

See the next section for a guide on setting up your `.env` file.

You will need to use [ngrok][3] to make `localhost:3000` available to
the internet. You should use the secure HTTPS URL generated by ngrok to
create your app with on your Partners dashboard.

```console
$ ngrok http 3000
```

To start the app, simply run:

```console
$ rails s
```

Your requests to protected resources should now be secured with an `Authorization: Bearer token` header.

![App dashboard][s1]

_**Above:** Example text received from a protected `/graphql` endpoint_

![App requests][s2]

_**Above:** Requests made to the protected `/graphql` endpoint are automatically
authorized using a JWT token_

## Creating your own app

To create your own local app, you can follow the [guides available on
shopify.dev][4]. You may then choose to skip ahead to the section [__Making authenticated
requests using App-Bridge__](#making-authenticated-requests-using-app-bridge).
Alternatively, follow the guide below to build a basic app using React and
Rails. This guide should take 20-30 minutes.

### Bootstrap your rails app

This guide uses Rails 6 to build a [react-enabled rails app using
webpacker.][5] To get started, run the following in your working directory:

```console
$ rails new <your-app-name> --webpack=react
```

#### Add dependencies

1. To ensure that your app is using the latest Shopify App revision (at least
release [v13.3.0][6]), add the following gems to the Gemfile found in
`<your-app-name>`'s directory:

```rb
...

gem 'shopify_app', git: 'https://github.com/shopify/shopify_app'
gem 'react-rails'
gem 'dotenv-rails'
gem 'graphql'

gem 'graphiql-rails', group: :development
```

* Specifying the git repository for `shopify_app` retrieves the latest revision.

2. Install your gems by running:

```console
$ bundle install
```

#### Make your app React, GraphQL, and shopify_app ready

1. In the root folder of your app, run the following installers to ensure your
app is react-enabled via webpack:

```console
$ rails webpacker:install
$ rails webpacker:install:react
$ rails generate react:install
```

2. To create a sample GraphQL backend, run the following command. This command
creates a controller and sample type files:

```console
$ rails generate graphql:install
```

3. To bootstrap the dependencies required by the `shopify_app` gem, run the
following in the root directory of your app:

```console
$ rails generate shopify_app
```

4. Also in the root directory of your app, create a `.env` file to specify your
app's Shopify API Key and Shopify API Secret that were generated for your app
in your Partner's dashboard:

```sh
SHOPIFY_API_KEY=<Your Shopify API Key>
SHOPIFY_API_SECRET=<Your Shopify API Secret>
SHOPIFY_DOMAIN=<Your Shopify domain, default to myshopify.com>
```

* This sample includes `SHOPIFY_DOMAIN` to help first-party app developers
easily specify their local domains (e.g `myshopify.com` and `myshopify.io`)
* `SHOPIFY_DOMAIN` is entirely optional; you can simply hard-code `myshopify.com` where relevant

5. Add the following to your `.gitignore` file:

```sh
.env
```

6. Run any outstanding migrations before you continue.

```console
$ bin/rails db:migrate
```

### Install your app on a Shopify store

Before you can install your app on your store, there are a few changes required.

1. In `config/initializers/shopify_app.rb` add the following to the
`ShopifyApp.configure` block:

```rb
ShopifyApp.configure do |config|
  â€¦
  config.allow_jwt_authentication = true
  config.myshopify_domain = ENV['SHOPIFY_DOMAIN']
end

ShopifyAPI::Session.myshopify_domain = ENV['SHOPIFY_DOMAIN']
```

* `config.allow_jwt_authentication = true` ensures that your app is configured to allow JWT-based
  authentication
* You should also edit `app/views/layouts/embedded_app.html.erb` so that it looks like this:

2. In `config/initializers/omniauth.rb` add:

```rb
strategy.options[:myshopify_domain] = ENV['SHOPIFY_DOMAIN']
```

3. You should be able to install your app to your Shopify store as normal.
The [following guide][7] has instructions on how to do this.

### Create a sample React component

This example uses [Shopify/Polaris][8] and an [Apollo client][9] to ensure that
all subsequent requests made within your app are authenticated.

1. Use yarn to add the following dependencies to your project:

```console
$ yarn add \
       apollo-boost \
       @apollo/react-hooks \
       graphql \
       @shopify/polaris \
       @shopify/app-bridge-utils@1.22.0 \
       react-apollo
```

* __Important:__ Make sure `@shopify/app-bridge-utils` is using the [release
`v1.22.0` or later][10]

2. Use rails to generate a new component called `App.js` in `app/javascript/components/`:

```console
$ rails generate react:component App
```

3. Overwrite `app/views/home/index.html` to match something similar to the following:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@4.22.0/styles.min.css"/>
  </head>
  <body>
    <%= react_component("App") %>
  </body>
</html>
```

### Making authenticated requests using App-Bridge

This section assumes that your app meets the following prerequisites: 

* Your app has the Next-Gen Auth beta feature enabled on Shopify
* Your app is configured to allow JWT-based authentication
* Your `shopify_app` gem is updated to at least [`v13.3.0`][6]
* Your `app-bridge-utils` npm library is updated to at least [`v1.22.0`][10]
  - You can ensure this by running `yarn add @shopify/app-bridge-utils@1.22.0` in the root directory of your project

#### Changes required on the backend

1. Add the module `ShopifyApp::RequireKnownShop` to
`app/controllers/home_controller.rb` along with the `@shop_origin` instance
variable to your `index` method.

```rb
# frozen_string_literal: true

class HomeController < ApplicationController
  include ShopifyApp::EmbeddedApp
  include ShopifyApp::RequireKnownShop

  def index
    @shop_origin = current_shopify_domain
  end
end
```

2. Add a `protect_from_forgery` check in
`app/controllers/authenticated_controller.rb`.

```rb
# frozen_string_literal: true

class AuthenticatedController < ApplicationController
  include ShopifyApp::Authenticated

  protect_from_forgery with: :exception, unless: :valid_jwt_header?

  private

  def valid_jwt_header?
    jwt_shopify_domain.present?
  end
end
```

* This ensures that if your app is using JWT, the shop domain can be
validated appropriately without cookies
* The check `valid_jwt_header?` is temporary and will most likely be moved to
`shopify_app` in a future release

3. If you are trying to protect a resource in your routes file, you can do so
by extending that resource to be of class `AuthenticatedController`. In this
example, we are protecting our `/graphql` endpoint, so we made the following
change to `app/controllers/graphql_controller.rb`:

```rb
class GraphqlController < AuthenticatedController
```

#### Changes required on the frontend 

1. In `app/views/layout/embedded_app.html.erb`, change the following content_tag:

```html+erb
<%= content_tag(:div, nil, id: 'shopify-app-init', data: {
  api_key: ShopifyApp.configuration.api_key,
  shop_origin: (@current_shopify_session.domain if @current_shopify_session),
  debug: Rails.env.development?
} ) %>
```
to the following:

```html+erb
<%= content_tag(:div, nil, id: 'shopify-app-init', data: {
  api_key: ShopifyApp.configuration.api_key,
  shop_origin: (@shop_origin),
  debug: Rails.env.development?
} ) %>
```

* `@shop_origin` is now provided by `app/controllers/home_controller.rb#index`.

2. Create an apollo client in `app/javascript/components/App.js` to use as a
prop to `ApolloProvider`: 

```js
import ApolloClient from 'apollo-client';
import { ApolloProvider } from '@apollo/react-hooks';
import { authenticatedFetch } from '@shopify/app-bridge-utils';
import { HttpLink } from 'apollo-link-http';
import { InMemoryCache } from 'apollo-cache-inmemory';
import React from 'react';

class App extends React.Component {
  render () {
    const client = new ApolloClient({
      link: new HttpLink({
        credentials: 'same-origin',
        fetch: authenticatedFetch(window.app), // created in shopify_app.js
        uri: '/graphql'
      }),
      cache: new InMemoryCache()
    });

    return (
      <ApolloProvider client={client}>
        ...
      </ApolloProvider>
    );
  }
}
export default App;
```

* `authenticatedFetch()` is a function provided by `app-bridge-utils`. It is
responsible for appending an `Authorization` header along with an authenticated
Bearer JWT to all of your requests. This method allows you to fetch protected
resources easily.
* `authenticatedFetch()` requires an AppBridge instance. If you bootstrapped
your application using the `shopify_app` gem, an AppBridge instance is
available as `window.app` automatically through
`app/javascript/shopify_app/shopify_app.js`:

```js
document.addEventListener('DOMContentLoaded', () => {
  var data = document.getElementById('shopify-app-init').dataset;
  var AppBridge = window['app-bridge'];
  var createApp = AppBridge.default;
  window.app = createApp({          // Adds an AppBridge instance to window
    apiKey: data.apiKey,
    shopOrigin: data.shopOrigin
  });

  var actions = AppBridge.actions;
  var TitleBar = actions.TitleBar;
  TitleBar.create(app, {
    title: data.page
  });
});
```

* Alternatively, you could create your own AppBridge instance in 
`app/javascript/components/App.js` as well:

```js
import ApolloClient from 'apollo-client';
import { ApolloProvider } from '@apollo/react-hooks';
import { authenticatedFetch } from '@shopify/app-bridge-utils';
import { createApp } from '@shopify/app-bridge';
import { HttpLink } from 'apollo-link-http';
import { InMemoryCache } from 'apollo-cache-inmemory';
import React from 'react';

class App extends React.Component {
  render () {
    const data = document.getElementById('shopify-app-init').dataset;
    const apiKey = data.apiKey;
    const shopOrigin = data.shopOrigin;

    const app = createApp({
      apiKey: apiKey,
      shopOrigin: shopOrigin
    });

    const client = new ApolloClient({
      link: new HttpLink({
        credentials: 'same-origin',
        fetch: authenticatedFetch(app),
        uri: '/graphql'
      }),
      cache: new InMemoryCache()
    });

    return (
      <ApolloProvider client={client}>
        ...
      </ApolloProvider>
    );
  }
}
export default App;
```

#### Querying GraphQL

All future requests your app makes should now be authorized using JWT. To
summarize, this example makes a call to a protected resource of ours found at
`/graphql`. In our example, we make a query to the field called `test_field`
found in `app/graphql/types/query_type.rb`:

```rb
module Types
  class QueryType < Types::BaseObject
    # Add root-level fields here.
    # They will be entry points for queries on your schema.

    # TODO: remove me
    field :test_field, String, null: false,
      description: "An example field added by the generator"
    def test_field
      "Congratulations! Your requests are now authorized using Next-Gen Auth."
    end
  end
end
```

To load the query on our test page, we are using `useQuery` from
`@apollo/react-hooks`.

1. Create a new component at `app/javascript/components/TestData.js`:

```js
import {gql} from "apollo-boost";
import React from "react";
import {useQuery} from "@apollo/react-hooks";

const TEST_QUERY = gql`query { testField }`;

export default function TestData() {
    const {loading, error, data} = useQuery(TEST_QUERY);

    if (loading) {
        return (
            <div>'Loading'</div>
        );
    } else if (error) {
        return (
            <div>'Something went wrong!'</div>
        );
    } else {
        return (
            <p>{data.testField}</p>
        );
    }
}
```

* This component is solely responsible for querying `test_field` and then showing the results

2. If your dashboard returns the following text:

> Congratulations! Your requests are now authorized using Next-Gen Auth.

Your app has successfully made an authorized request to a protected
resource. You can also check your network activity to monitor outbound requests
your app makes to ensure that among the Request Headers, there is a valid
`Authorization: Bearer token` header present.


[//]: # "Links"
[s1]: ./app/assets/images/screen-shot-1.png
[s2]: ./app/assets/images/screen-shot-2.png
[1]: https://drive.google.com/open?id=1KuWZc10Hnp0vCfR8ulYHVlazjA1RfXx9iDHb2d5e6Hk
[2]: https://development.shopify.io/engineering/developing_at_Shopify/apps/first-party_apps/create_and_install_an_app_locally#Register_your_app_with_a_Shopify_Partners_account
[3]: https://www.shopify.in/partners/blog/shopify-admin-authenticate-app
[4]: https://shopify.dev/tutorials/build-a-shopify-app-with-node-and-react
[5]: https://github.com/reactjs/react-rails#get-started-with-webpacker
[6]: https://github.com/Shopify/shopify_app/releases/tag/v13.3.0
[7]: https://shopify.dev/tutorials/build-a-shopify-app-with-node-and-express#step-2-create-and-configure-your-app-in-the-partner-dashboard
[8]: https://polaris.shopify.com/
[9]: https://www.apollographql.com/docs/react/
[10]: https://www.npmjs.com/package/@shopify/app-bridge/v/1.22.0
